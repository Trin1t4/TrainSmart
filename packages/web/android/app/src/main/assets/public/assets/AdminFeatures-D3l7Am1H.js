import{j as e,s as $,w as N,R as z,aK as O,aL as U,aM as P,aN as q,aO as B,q as G,aP as K,D as H,r as k,p as Q,aQ as Y,aR as J}from"./vendor-ui-B5xs3EUI.js";import{u as V,a as c,L as W}from"./vendor-react-DLKD8xKB.js";import{s as p,a2 as X}from"./index-CsHuaFST.js";import"./vendor-supabase-DF1H9KNm.js";async function Z(){try{const{data:l,error:n}=await p.rpc("admin_list_features");if(n)throw console.error("[FeatureService] Error listing features:",n),n;return l||[]}catch(l){throw console.error("[FeatureService] Exception in adminListFeatures:",l),l}}async function ee(l,n){try{const{data:t,error:i}=await p.rpc("admin_toggle_feature",{p_feature_key:l,p_enabled:n});if(i)throw console.error("[FeatureService] Error toggling feature:",i),i;return y(),t===!0}catch(t){throw console.error("[FeatureService] Exception in adminToggleFeature:",t),t}}async function re(l,n){try{const{data:t,error:i}=await p.rpc("admin_set_feature_tier",{p_feature_key:l,p_min_tier:n});if(i)throw console.error("[FeatureService] Error setting feature tier:",i),i;return y(),t===!0}catch(t){throw console.error("[FeatureService] Exception in adminSetFeatureTier:",t),t}}async function ae(l,n,t,i="base",f,d={}){try{const{data:x,error:u}=await p.rpc("admin_create_feature",{p_key:l,p_name:n,p_description:t||null,p_min_tier:i,p_category:f||null,p_metadata:d});if(u)throw console.error("[FeatureService] Error creating feature:",u),u;return y(),x}catch(x){throw console.error("[FeatureService] Exception in adminCreateFeature:",x),x}}const se=new Map;function y(){se.clear()}const te={base:"bg-green-900/30 text-green-400 border-green-500/30",premium:"bg-purple-900/30 text-purple-400 border-purple-500/30",elite:"bg-amber-900/30 text-amber-400 border-amber-500/30"},S={training:H,ai:K,analytics:G,social:B,support:q,beta:P};function ce(){const l=V(),[n,t]=c.useState(!0),[i,f]=c.useState(!1),[d,x]=c.useState([]),[u,w]=c.useState(null),[j,E]=c.useState("all"),[b,L]=c.useState(""),[T,v]=c.useState(!1),[_,C]=c.useState(!1),[s,g]=c.useState({key:"",name:"",description:"",min_tier:"base",category:"training"});c.useEffect(()=>{A()},[]);async function A(){try{if(t(!0),!await X()){w("Accesso negato"),setTimeout(()=>l("/dashboard"),2e3);return}f(!0),await h()}catch(r){const a=r instanceof Error?r.message:"Unknown error";w(a)}finally{t(!1)}}async function h(){try{C(!0);const r=await Z();x(r)}catch(r){const a=r instanceof Error?r.message:"Errore caricamento";console.error("Errore caricamento features:",a)}finally{C(!1)}}async function M(r){try{await ee(r.key,!r.is_enabled),await h()}catch(a){const o=a instanceof Error?a.message:"Errore";console.error("Errore toggle:",o)}}async function R(r,a){try{await re(r.key,a),await h()}catch(o){const m=o instanceof Error?o.message:"Errore";console.error("Errore cambio tier:",m)}}async function D(r){r.preventDefault();try{await ae(s.key,s.name,s.description,s.min_tier,s.category),v(!1),g({key:"",name:"",description:"",min_tier:"base",category:"training"}),await h()}catch(a){const o=a instanceof Error?a.message:"Errore";console.error("Errore creazione:",o)}}const I=["all",...new Set(d.map(r=>r.category||"other"))],F=d.filter(r=>{const a=j==="all"||r.category===j,o=!b||r.name.toLowerCase().includes(b.toLowerCase())||r.key.toLowerCase().includes(b.toLowerCase());return a&&o});return n?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-black flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-16 w-16 border-b-2 border-emerald-500"})}):u||!i?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-black flex items-center justify-center",children:e.jsxs("div",{className:"bg-red-900/20 border border-red-500 rounded-lg p-8",children:[e.jsx("h2",{className:"text-2xl font-bold text-red-400",children:"Accesso Negato"}),e.jsx("p",{className:"text-slate-300 mt-2",children:u})]})}):e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-black text-white",children:[e.jsx("header",{className:"bg-slate-800/50 backdrop-blur-sm border-b border-slate-700 sticky top-0 z-10",children:e.jsxs("div",{className:"container mx-auto px-4 py-4 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(W,{to:"/admin",className:"p-2 hover:bg-slate-700 rounded-lg transition",children:e.jsx($,{className:"w-5 h-5"})}),e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold flex items-center gap-2",children:[e.jsx(N,{className:"w-6 h-6 text-emerald-400"}),"Feature Flags"]}),e.jsx("p",{className:"text-slate-400 text-sm",children:"Gestione feature e accessi per tier"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:h,disabled:_,className:"p-2 bg-slate-700 hover:bg-slate-600 rounded-lg transition disabled:opacity-50",children:e.jsx(z,{className:`w-5 h-5 ${_?"animate-spin":""}`})}),e.jsxs("button",{onClick:()=>v(!0),className:"px-4 py-2 bg-emerald-600 hover:bg-emerald-500 rounded-lg transition flex items-center gap-2",children:[e.jsx(O,{className:"w-4 h-4"}),"Nuova Feature"]})]})]})}),e.jsxs("div",{className:"container mx-auto px-4 py-8",children:[e.jsxs("div",{className:"flex flex-col md:flex-row gap-4 mb-6",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(U,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400"}),e.jsx("input",{type:"text",placeholder:"Cerca feature...",value:b,onChange:r=>L(r.target.value),className:`w-full pl-10 pr-4 py-2 bg-slate-800 border border-slate-700 rounded-lg\r
                         focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500 transition`})]}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:I.map(r=>{const a=r!=="all"?S[r]||N:null;return e.jsxs("button",{onClick:()=>E(r),className:`px-4 py-2 rounded-lg transition flex items-center gap-2 ${j===r?"bg-emerald-600 text-white":"bg-slate-700 text-slate-300 hover:bg-slate-600"}`,children:[a&&e.jsx(a,{className:"w-4 h-4"}),r==="all"?"Tutte":r]},r)})})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 mb-6",children:[e.jsxs("div",{className:"bg-slate-800/50 rounded-xl p-4 border border-slate-700",children:[e.jsx("div",{className:"text-2xl font-bold text-white",children:d.length}),e.jsx("div",{className:"text-sm text-slate-400",children:"Features Totali"})]}),e.jsxs("div",{className:"bg-slate-800/50 rounded-xl p-4 border border-slate-700",children:[e.jsx("div",{className:"text-2xl font-bold text-green-400",children:d.filter(r=>r.is_enabled).length}),e.jsx("div",{className:"text-sm text-slate-400",children:"Attive"})]}),e.jsxs("div",{className:"bg-slate-800/50 rounded-xl p-4 border border-slate-700",children:[e.jsx("div",{className:"text-2xl font-bold text-purple-400",children:d.filter(r=>r.min_tier==="premium").length}),e.jsx("div",{className:"text-sm text-slate-400",children:"Premium"})]}),e.jsxs("div",{className:"bg-slate-800/50 rounded-xl p-4 border border-slate-700",children:[e.jsx("div",{className:"text-2xl font-bold text-amber-400",children:d.filter(r=>r.min_tier==="elite").length}),e.jsx("div",{className:"text-sm text-slate-400",children:"Elite"})]})]}),e.jsx("div",{className:"grid gap-4",children:F.map((r,a)=>{const o=S[r.category||""]||N;return e.jsx(k.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:a*.03},className:`bg-slate-800/50 rounded-xl p-6 border ${r.is_enabled?"border-slate-700":"border-red-900/50 bg-red-900/10"}`,children:e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("div",{className:`p-2 rounded-lg ${r.is_enabled?"bg-slate-700":"bg-red-900/30"}`,children:e.jsx(o,{className:`w-5 h-5 ${r.is_enabled?"text-emerald-400":"text-red-400"}`})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-white",children:r.name}),e.jsx("code",{className:"text-xs text-slate-500 font-mono",children:r.key})]})]}),e.jsx("p",{className:"text-slate-400 text-sm mb-4",children:r.description}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-slate-500",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Q,{className:"w-4 h-4"}),r.override_count," override"]}),e.jsxs("span",{children:["Creata: ",new Date(r.created_at).toLocaleDateString("it-IT")]})]})]}),e.jsxs("div",{className:"flex flex-col items-end gap-3",children:[e.jsx("button",{onClick:()=>M(r),className:`flex items-center gap-2 px-4 py-2 rounded-lg font-medium transition ${r.is_enabled?"bg-green-600 hover:bg-green-500":"bg-red-600 hover:bg-red-500"}`,children:r.is_enabled?e.jsxs(e.Fragment,{children:[e.jsx(Y,{className:"w-5 h-5"}),"Attiva"]}):e.jsxs(e.Fragment,{children:[e.jsx(J,{className:"w-5 h-5"}),"Disattiva"]})}),e.jsx("div",{className:"flex gap-1",children:["base","premium","elite"].map(m=>e.jsx("button",{onClick:()=>R(r,m),className:`px-3 py-1.5 rounded border text-xs font-medium transition uppercase ${r.min_tier===m?te[m]:"bg-slate-700/50 text-slate-400 border-slate-600 hover:bg-slate-600"}`,children:m},m))})]})]})},r.id)})}),F.length===0&&e.jsx("div",{className:"text-center py-12 text-slate-500",children:"Nessuna feature trovata"})]}),T&&e.jsx("div",{className:"fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4",children:e.jsxs(k.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},className:"bg-slate-800 rounded-xl p-6 w-full max-w-md border border-slate-700",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"Nuova Feature"}),e.jsxs("form",{onSubmit:D,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-slate-400 mb-1",children:"Key (identificatore)"}),e.jsx("input",{type:"text",value:s.key,onChange:r=>g({...s,key:r.target.value.toLowerCase().replace(/\s/g,"_")}),placeholder:"es. new_feature",required:!0,className:`w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg\r
                             focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500`})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-slate-400 mb-1",children:"Nome"}),e.jsx("input",{type:"text",value:s.name,onChange:r=>g({...s,name:r.target.value}),placeholder:"Nome della feature",required:!0,className:`w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg\r
                             focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500`})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-slate-400 mb-1",children:"Descrizione"}),e.jsx("textarea",{value:s.description,onChange:r=>g({...s,description:r.target.value}),placeholder:"Descrizione della feature",rows:3,className:`w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg\r
                             focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500`})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-slate-400 mb-1",children:"Tier Minimo"}),e.jsxs("select",{value:s.min_tier,onChange:r=>g({...s,min_tier:r.target.value}),className:`w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg\r
                               focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500`,children:[e.jsx("option",{value:"base",children:"Base"}),e.jsx("option",{value:"premium",children:"Premium"}),e.jsx("option",{value:"elite",children:"Elite"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm text-slate-400 mb-1",children:"Categoria"}),e.jsxs("select",{value:s.category,onChange:r=>g({...s,category:r.target.value}),className:`w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-lg\r
                               focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500`,children:[e.jsx("option",{value:"training",children:"Training"}),e.jsx("option",{value:"ai",children:"AI"}),e.jsx("option",{value:"analytics",children:"Analytics"}),e.jsx("option",{value:"social",children:"Social"}),e.jsx("option",{value:"support",children:"Support"}),e.jsx("option",{value:"beta",children:"Beta"})]})]})]}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx("button",{type:"button",onClick:()=>v(!1),className:"flex-1 px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg transition",children:"Annulla"}),e.jsx("button",{type:"submit",className:"flex-1 px-4 py-2 bg-emerald-600 hover:bg-emerald-500 rounded-lg transition font-medium",children:"Crea Feature"})]})]})]})})]})}export{ce as default};
